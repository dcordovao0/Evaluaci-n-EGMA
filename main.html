<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integral EGMA Ecuador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white; }
            .shadow-md, .shadow-lg { box-shadow: none !important; }
        }
        .tab-active { border-bottom: 4px solid #2563eb; color: #1e40af; font-weight: bold; }
        .radio-label { cursor: pointer; transition: all 0.2s; }
        .radio-input:checked + .radio-content { background-color: #ebf8ff; border-color: #4299e1; border-width: 2px; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <!-- BARRA DE NAVEGACI칍N SUPERIOR -->
    <nav class="bg-white shadow-md sticky top-0 z-50 no-print">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-2">
                    <span class="text-2xl">游늵</span>
                    <span class="font-bold text-xl text-gray-800">EGMA Manager</span>
                </div>
                <div class="flex space-x-4">
                    <button onclick="switchTab('evaluador')" id="btn-evaluador" class="tab-active py-4 px-4 hover:bg-gray-50 focus:outline-none">
                        游닇 Modo Evaluador
                    </button>
                    <button onclick="switchTab('analista')" id="btn-analista" class="text-gray-500 py-4 px-4 hover:bg-gray-50 focus:outline-none">
                        游늳 Modo Analista (Reporte Curso)
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- PESTA칌A 1: MODO EVALUADOR (FORMULARIO) -->
    <div id="tab-evaluador" class="max-w-4xl mx-auto my-8 p-4">
        
        <div class="bg-blue-700 text-white p-6 rounded-t-xl shadow-lg">
            <h1 class="text-2xl font-bold text-center uppercase">Ficha de Evaluaci칩n Individual</h1>
            <p class="text-center opacity-90">Protocolo EGMA - Subnivel Medio</p>
        </div>

        <form id="evalForm" class="bg-white p-6 shadow-lg rounded-b-xl space-y-8">
            
            <!-- Datos del Estudiante -->
            <section class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h2 class="text-lg font-semibold mb-4 text-blue-800 border-b pb-2">Datos Informativos</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nombre del Estudiante</label>
                        <input type="text" id="studentName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500" placeholder="Apellido, Nombre">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Grado / Paralelo</label>
                        <input type="text" id="studentGrade" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500">
                    </div>
                </div>
            </section>

            <!-- GENERADOR DE PREGUNTAS (Script genera esto din치micamente para ahorrar espacio) -->
            <div id="questionsContainer"></div>

            <!-- Secci칩n Errores -->
            <section class="bg-red-50 p-6 rounded-lg border border-red-200">
                <h2 class="text-xl font-bold text-red-800 mb-4">Detecci칩n de Errores Conceptuales</h2>
                <div id="errorsContainer" class="space-y-4"></div>
            </section>

            <!-- Botones de Acci칩n -->
            <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4 mt-8 pt-6 border-t">
                <button type="button" onclick="saveEvaluation()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg flex items-center justify-center space-x-2 transition transform hover:-translate-y-1">
                    <span>游 Guardar Archivo del Estudiante</span>
                </button>
                <button type="reset" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-lg shadow transition">
                    Limpiar Formulario
                </button>
            </div>
            <p class="text-center text-xs text-gray-500 mt-2">
                * Al hacer clic en Guardar, se descargar치 un archivo .json. Gu치rdelo en la carpeta del curso.
            </p>

        </form>
    </div>

    <!-- PESTA칌A 2: MODO ANALISTA (DASHBOARD) -->
    <div id="tab-analista" class="hidden max-w-6xl mx-auto my-8 p-4">
        
        <div class="bg-white p-8 rounded-xl shadow-lg text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Consolidado de Resultados del Curso</h2>
            <p class="text-gray-600 mb-6">Seleccione todos los archivos (.json) generados por los evaluadores para procesar las estad칤sticas autom치ticamente.</p>
            
            <div class="flex justify-center">
                <label class="w-full md:w-1/2 flex flex-col items-center px-4 py-6 bg-white text-blue rounded-lg shadow-lg tracking-wide uppercase border border-blue cursor-pointer hover:bg-blue-50 transition border-blue-500 text-blue-500">
                    <svg class="w-8 h-8" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                        <path d="M16.88 9.1A4 4 0 0 1 16 17H5a5 5 0 0 1-1-9.9V7a3 3 0 0 1 4.52-2.59A4.98 4.98 0 0 1 17 8c0 .38-.04.74-.12 1.1zM11 11h3l-4-4-4 4h3v3h2v-3z" />
                    </svg>
                    <span class="mt-2 text-base leading-normal">Seleccionar Archivos de Evaluaci칩n</span>
                    <input type='file' id="fileInput" multiple accept=".json" class="hidden" onchange="processFiles()" />
                </label>
            </div>
            <p id="fileCount" class="mt-4 font-bold text-green-600"></p>
        </div>

        <!-- Resultados -->
        <div id="dashboardResults" class="hidden space-y-8">
            
            <!-- Resumen General -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow border-l-4 border-blue-500">
                    <h3 class="text-gray-500 text-sm font-bold uppercase">Total Estudiantes</h3>
                    <p class="text-4xl font-bold text-gray-800" id="totalStudents">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow border-l-4 border-green-500">
                    <h3 class="text-gray-500 text-sm font-bold uppercase">Promedio Global (Nivel)</h3>
                    <p class="text-4xl font-bold text-gray-800" id="globalAverage">0.0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow border-l-4 border-red-500">
                    <h3 class="text-gray-500 text-sm font-bold uppercase">Estudiantes en Riesgo (Nivel 1)</h3>
                    <p class="text-4xl font-bold text-gray-800" id="riskStudents">0</p>
                </div>
            </div>

            <!-- Gr치ficos de Preguntas -->
            <div class="bg-white p-6 rounded-xl shadow">
                <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2">Desempe침o por Pregunta</h3>
                <div class="h-80">
                    <canvas id="questionsChart"></canvas>
                </div>
            </div>

            <!-- Tabla de Errores -->
            <div class="bg-white p-6 rounded-xl shadow">
                <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2">Prevalencia de Errores Conceptuales</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-6 py-3">Error Conceptual</th>
                                <th class="px-6 py-3">Casos Detectados</th>
                                <th class="px-6 py-3 text-center">% del Curso</th>
                                <th class="px-6 py-3">Barra de Frecuencia</th>
                            </tr>
                        </thead>
                        <tbody id="errorsTableBody">
                            <!-- Filas generadas por JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tabla Detallada -->
            <div class="bg-white p-6 rounded-xl shadow overflow-hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Detalle de Estudiantes</h3>
                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-3">Nombre</th>
                                <th class="p-3 text-center">P1.1</th>
                                <th class="p-3 text-center">P1.2</th>
                                <th class="p-3 text-center">P1.3</th>
                                <th class="p-3 text-center">P2.1</th>
                                <th class="p-3 text-center">P2.2</th>
                                <th class="p-3 text-center">P3.1</th>
                                <th class="p-3 text-center">P3.2</th>
                                <th class="p-3 text-center">P4.1</th>
                                <th class="p-3 text-center">P4.2</th>
                            </tr>
                        </thead>
                        <tbody id="detailsTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATOS DEL FORMULARIO ---
        const questionsData = [
            { id: "q1_1", title: "1.1 Concepto Hist칩rico", desc: "Invenci칩n de s칤mbolos / Registro" },
            { id: "q1_2", title: "1.2 Lectura de N칰meros", desc: "405.012.030" },
            { id: "q1_3", title: "1.3 Valor Posicional", desc: "Descomposici칩n aditiva" },
            { id: "q2_1", title: "2.1 Sucesi칩n Creciente", desc: "Patr칩n complejo (+50)" },
            { id: "q2_2", title: "2.2 Sucesi칩n Decreciente", desc: "Patr칩n inverso (-8)" },
            { id: "q3_1", title: "3.1 Fluidez Multiplicativa", desc: "Cronometrada (60s)" },
            { id: "q3_2", title: "3.2 Heur칤stica/Trucos", desc: "Tabla del 9 / x1000" },
            { id: "q4_1", title: "4.1 Resoluci칩n Problemas", desc: "F치brica de Chocolate" },
            { id: "q4_2", title: "4.2 Vocabulario", desc: "T칠rminos de la multiplicaci칩n" }
        ];

        const errorsData = [
            { id: "err_1", title: "Sintaxis (Concatenaci칩n)", desc: "Escribe 3000500 por 3.500" },
            { id: "err_2", title: "Magnitud", desc: "Falla comparaci칩n longitudes iguales" },
            { id: "err_3", title: "Fluidez (Conteo)", desc: "Suma repetida en vez de multiplicar" },
            { id: "err_4", title: "Resta Invertida", desc: "Resta menor al mayor siempre" },
            { id: "err_5", title: "Modelado (Palabra Clave)", desc: "Opera sin contexto" },
            { id: "err_6", title: "Vocabulario Confuso", desc: "Confunde t칠rminos" }
        ];

        // --- INICIALIZACI칍N ---
        document.addEventListener('DOMContentLoaded', () => {
            renderQuestions();
            renderErrors();
        });

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            questionsData.forEach(q => {
                const html = `
                <div class="mb-6 p-4 border rounded-lg hover:shadow-sm transition bg-white">
                    <h3 class="font-bold text-lg mb-1">${q.title}</h3>
                    <p class="text-sm text-gray-500 mb-3">${q.desc}</p>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-3">
                        ${[1,2,3,4].map(level => `
                        <label class="radio-label block relative">
                            <input type="radio" name="${q.id}" value="${level}" class="radio-input sr-only">
                            <div class="radio-content p-3 border rounded-md text-sm h-full hover:bg-gray-50 flex flex-col justify-center items-center text-center">
                                <span class="font-bold block ${getColorText(level)}">Nivel ${level}</span>
                            </div>
                        </label>`).join('')}
                    </div>
                    <input type="text" name="${q.id}_obs" class="w-full p-2 border rounded text-xs bg-gray-50" placeholder="Observaci칩n para ${q.title}">
                </div>`;
                container.innerHTML += html;
            });
        }

        function renderErrors() {
            const container = document.getElementById('errorsContainer');
            errorsData.forEach(e => {
                const html = `
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-center border-b border-red-100 pb-2 last:border-0">
                    <div class="md:col-span-8">
                        <span class="font-bold text-gray-800">${e.title}</span>
                        <p class="text-xs text-gray-600">${e.desc}</p>
                    </div>
                    <div class="md:col-span-4 flex space-x-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="${e.id}" value="si" class="w-5 h-5 text-red-600"> <span>S칤</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="${e.id}" value="no" class="w-5 h-5 text-green-600" checked> <span>No</span>
                        </label>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        function getColorText(level) {
            return ['text-red-600', 'text-orange-500', 'text-green-600', 'text-blue-600'][level-1];
        }

        // --- L칍GICA DE PESTA칌AS ---
        function switchTab(tab) {
            document.getElementById('tab-evaluador').classList.toggle('hidden', tab !== 'evaluador');
            document.getElementById('tab-analista').classList.toggle('hidden', tab !== 'analista');
            
            // Actualizar estilos botones
            const btnEval = document.getElementById('btn-evaluador');
            const btnAnal = document.getElementById('btn-analista');
            
            if(tab === 'evaluador') {
                btnEval.className = 'tab-active py-4 px-4 hover:bg-gray-50 focus:outline-none';
                btnAnal.className = 'text-gray-500 py-4 px-4 hover:bg-gray-50 focus:outline-none';
            } else {
                btnEval.className = 'text-gray-500 py-4 px-4 hover:bg-gray-50 focus:outline-none';
                btnAnal.className = 'tab-active py-4 px-4 hover:bg-gray-50 focus:outline-none';
            }
        }

        // --- L칍GICA DE GUARDADO (JSON) ---
        function saveEvaluation() {
            const form = document.getElementById('evalForm');
            const studentName = document.getElementById('studentName').value;
            
            if (!studentName) { alert("Por favor ingrese el nombre del estudiante"); return; }

            const data = {
                student: studentName,
                grade: document.getElementById('studentGrade').value,
                timestamp: new Date().toISOString(),
                answers: {},
                errors: {}
            };

            // Recolectar respuestas niveles
            questionsData.forEach(q => {
                const selected = form.querySelector(`input[name="${q.id}"]:checked`);
                data.answers[q.id] = selected ? parseInt(selected.value) : 0;
            });

            // Recolectar errores
            errorsData.forEach(e => {
                const selected = form.querySelector(`input[name="${e.id}"]:checked`);
                data.errors[e.id] = selected ? selected.value : 'no';
            });

            // Descargar Archivo
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            const fileName = `EGMA_${studentName.replace(/ /g,"_")}.json`;
            downloadAnchorNode.setAttribute("download", fileName);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // --- L칍GICA DE AN츼LISIS ---
        let chartInstance = null;

        async function processFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (files.length === 0) return;

            document.getElementById('fileCount').innerText = `Procesando ${files.length} archivos...`;
            
            const evaluations = [];
            
            // Leer archivos as칤ncronamente
            const readFile = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = event => resolve(JSON.parse(event.target.result));
                    reader.onerror = error => reject(error);
                    reader.readAsText(file);
                });
            };

            try {
                for (let file of files) {
                    const data = await readFile(file);
                    evaluations.push(data);
                }
                generateReport(evaluations);
                document.getElementById('fileCount').innerText = `춰칄xito! Datos cargados de ${files.length} estudiantes.`;
                document.getElementById('dashboardResults').classList.remove('hidden');
            } catch (err) {
                alert("Error leyendo archivos. Aseg칰rese de que sean los JSON generados por el evaluador.");
                console.error(err);
            }
        }

        function generateReport(data) {
            // 1. Totales
            const total = data.length;
            document.getElementById('totalStudents').innerText = total;

            // 2. Promedio y Riesgo
            let sumLevels = 0;
            let countLevels = 0;
            let studentsInRisk = 0; // Tienen Nivel 1 en m치s del 50% de preguntas

            data.forEach(student => {
                let sLevels = 0;
                let sCount = 0;
                let nivel1Count = 0;
                
                Object.values(student.answers).forEach(val => {
                    if(val > 0) {
                        sLevels += val;
                        sCount++;
                        if(val === 1) nivel1Count++;
                    }
                });

                if(sCount > 0) {
                    sumLevels += (sLevels/sCount);
                    countLevels++;
                }
                if(nivel1Count >= 4) studentsInRisk++; // Criterio ejemplo
            });

            const avg = countLevels > 0 ? (sumLevels / countLevels).toFixed(2) : 0;
            document.getElementById('globalAverage').innerText = avg;
            document.getElementById('riskStudents').innerText = studentsInRisk;
            
            // Colores sem치foro
            const riskEl = document.getElementById('riskStudents');
            riskEl.className = `text-4xl font-bold ${studentsInRisk > 0 ? 'text-red-600' : 'text-green-600'}`;

            // 3. Gr치fico de Barras (Niveles por Pregunta)
            renderChart(data);

            // 4. Tabla de Errores
            renderErrorsTable(data);

            // 5. Tabla de Detalles
            renderDetailsTable(data);
        }

        function renderChart(data) {
            const ctx = document.getElementById('questionsChart').getContext('2d');
            
            // Preparar datasets
            const labels = questionsData.map(q => q.id); // ids cortos para eje X
            
            // Calcular promedios por pregunta
            const averages = questionsData.map(q => {
                let sum = 0;
                let count = 0;
                data.forEach(s => {
                    if(s.answers[q.id]) { sum += s.answers[q.id]; count++; }
                });
                return count > 0 ? (sum / count).toFixed(2) : 0;
            });

            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nivel Promedio (1-4)',
                        data: averages,
                        backgroundColor: averages.map(v => v < 2 ? '#ef4444' : (v < 3 ? '#f97316' : '#22c55e')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 4, title: {display: true, text: 'Nivel de Logro'} }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (items) => {
                                    const qId = items[0].label;
                                    const qObj = questionsData.find(q => q.id === qId);
                                    return qObj ? qObj.title : qId;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderErrorsTable(data) {
            const tbody = document.getElementById('errorsTableBody');
            tbody.innerHTML = '';
            
            errorsData.forEach(err => {
                let count = 0;
                data.forEach(s => {
                    if (s.errors[err.id] === 'si') count++;
                });
                
                const percentage = ((count / data.length) * 100).toFixed(1);
                const barColor = percentage > 30 ? 'bg-red-500' : 'bg-blue-500';

                const row = `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-900">${err.title}</td>
                    <td class="px-6 py-4">${count} / ${data.length}</td>
                    <td class="px-6 py-4 text-center font-bold">${percentage}%</td>
                    <td class="px-6 py-4 w-1/3">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="${barColor} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function renderDetailsTable(data) {
            const tbody = document.getElementById('detailsTableBody');
            tbody.innerHTML = '';

            data.forEach(s => {
                let cells = `<td class="p-3 font-medium text-gray-900 sticky left-0 bg-white border-r">${s.student}</td>`;
                
                questionsData.forEach(q => {
                    const val = s.answers[q.id] || 0;
                    let color = 'text-gray-300';
                    if(val === 1) color = 'bg-red-100 text-red-800';
                    if(val === 2) color = 'bg-orange-100 text-orange-800';
                    if(val === 3) color = 'bg-green-100 text-green-800';
                    if(val === 4) color = 'bg-blue-100 text-blue-800';
                    
                    cells += `<td class="p-3 text-center border"><span class="px-2 py-1 rounded text-xs font-bold ${color}">${val}</span></td>`;
                });
                
                tbody.innerHTML += `<tr class="hover:bg-gray-50 border-b">${cells}</tr>`;
            });
        }
    </script>
</body>
</html>
