<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integral EGMA Ecuador - Versión Final PDF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Librería para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white; }
            .shadow-md, .shadow-lg { box-shadow: none !important; }
        }
        
        .radio-input:checked + .radio-content {
            background-color: #eff6ff; 
            border-color: #2563eb; 
            border-width: 2px;
            position: relative;
            z-index: 10;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1), 0 2px 4px -1px rgba(37, 99, 235, 0.06);
        }
        .radio-content {
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
            height: 100%; 
            cursor: pointer;
        }
        
        .tab-btn.active {
            border-bottom: 4px solid #2563eb;
            color: #1e40af;
            font-weight: bold;
        }
        .tab-btn {
            color: #6b7280;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <!-- BARRA SUPERIOR -->
    <nav class="bg-white shadow-md sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fa-solid fa-calculator text-blue-600 text-2xl mr-3"></i>
                    <span class="font-bold text-xl text-gray-800 tracking-tight">EGMA Manager <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded ml-2">PDF Ready</span></span>
                </div>
                <div class="flex space-x-4 md:space-x-8">
                    <button onclick="switchTab('evaluador')" id="btn-evaluador" class="tab-btn active flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium hover:text-blue-600">
                        <i class="fa-solid fa-user-pen mr-2"></i> Evaluador
                    </button>
                    <button onclick="switchTab('analista')" id="btn-analista" class="tab-btn flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium hover:text-blue-600">
                        <i class="fa-solid fa-chart-pie mr-2"></i> Analista
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- PESTAÑA 1: EVALUADOR -->
    <div id="view-evaluador" class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <div class="bg-white overflow-hidden shadow-xl sm:rounded-lg">
            <div class="bg-blue-700 p-6 rounded-t-lg text-white shadow-md">
                <div class="flex items-center justify-center mb-2">
                    <i class="fa-solid fa-clipboard-list text-3xl mr-3"></i>
                    <h2 class="text-2xl font-bold uppercase text-center">Ficha de Evaluación Individual</h2>
                </div>
                <p class="text-center opacity-90 text-sm">Protocolo EGMA - Subnivel Medio (5to a 7mo EGB)</p>
            </div>

            <form id="evalForm" class="p-6">
                <!-- Datos Estudiante -->
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-8 shadow-sm">
                    <h3 class="text-blue-800 font-bold border-b border-gray-300 pb-2 mb-4 text-lg">
                        <i class="fa-solid fa-id-card mr-2"></i>Datos Informativos
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Estudiante</label>
                            <input type="text" id="studentName" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2" placeholder="Apellido, Nombre">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Grado</label>
                            <select id="studentGrade" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2">
                                <option>5to EGB</option>
                                <option>6to EGB</option>
                                <option>7mo EGB</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                            <input type="date" id="evalDate" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2">
                        </div>
                    </div>
                </div>

                <!-- Contenedor de Preguntas Dinámicas -->
                <div id="questions-container" class="space-y-8">
                    <!-- Se llena con JS -->
                </div>

                <hr class="my-8 border-gray-200">

                <!-- Sección de Errores -->
                <div class="bg-red-50 border border-red-200 rounded-lg p-6 mb-8 shadow-sm">
                    <h3 class="text-xl font-bold text-red-800 mb-2 flex items-center">
                        <i class="fa-solid fa-triangle-exclamation mr-2"></i>Detección de Errores Conceptuales
                    </h3>
                    <p class="text-red-600 text-sm mb-6 bg-red-100 p-2 rounded inline-block">
                        <i class="fa-solid fa-circle-info mr-1"></i>
                        Marque SÍ únicamente si el error es evidente y repetitivo durante la prueba.
                    </p>
                    <div id="errors-container" class="space-y-3">
                        <!-- Se llena con JS -->
                    </div>
                </div>

                <!-- Botones Acción -->
                <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 pt-6 border-t bg-gray-50 sticky bottom-0 p-4 -mx-6 -mb-6 border-gray-200 z-20">
                    <button type="button" onclick="saveData()" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg flex items-center justify-center transition transform hover:-translate-y-1 text-lg border border-green-700">
                        <i class="fa-solid fa-floppy-disk mr-2"></i> Guardar y Descargar Archivo
                    </button>
                    <button type="button" onclick="resetForm()" class="w-full md:w-auto bg-white hover:bg-gray-100 text-gray-800 font-bold py-3 px-8 rounded-lg shadow border border-gray-300 transition text-lg">
                        <i class="fa-solid fa-eraser mr-2"></i> Limpiar Formulario
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- PESTAÑA 2: ANALISTA -->
    <div id="view-analista" class="hidden max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        
        <!-- Área de Carga -->
        <div class="bg-white p-10 rounded-xl shadow-lg text-center mb-8 border-2 border-dashed border-gray-300 hover:border-blue-500 transition-colors cursor-pointer group no-print" id="drop-zone" onclick="document.getElementById('fileInput').click()">
            <div class="mb-4">
                <span class="inline-block p-4 rounded-full bg-blue-50 group-hover:bg-blue-100 transition">
                    <i class="fa-solid fa-folder-open text-5xl text-blue-500"></i>
                </span>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mt-2">Cargar Evaluaciones del Curso</h2>
            <p class="text-gray-500 mb-6 max-w-md mx-auto">Haga clic aquí para seleccionar todos los archivos <code>.json</code> descargados por los evaluadores.</p>
            
            <input type="file" id="fileInput" multiple accept=".json" class="hidden" onchange="processFiles(this.files)">
            <button class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg transition pointer-events-none">
                <i class="fa-solid fa-upload mr-2"></i> Seleccionar Archivos
            </button>
            <p id="upload-status" class="mt-4 text-sm font-bold text-green-600 hidden animate-pulse"></p>
        </div>

        <!-- Dashboard de Resultados -->
        <div id="dashboard" class="hidden space-y-8">
            
            <!-- Botón Descargar PDF -->
            <div class="flex justify-end mb-4 no-print">
                <button onclick="downloadReportPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow flex items-center transition">
                    <i class="fa-solid fa-file-pdf mr-2"></i> Descargar Informe PDF
                </button>
            </div>

            <!-- Contenido del Reporte (Esto es lo que se imprime en PDF) -->
            <div id="report-content" class="bg-white p-8 rounded-lg shadow-lg">
                <div class="text-center mb-8 border-b pb-4">
                    <h2 class="text-3xl font-bold text-gray-800">Informe Consolidado EGMA</h2>
                    <p class="text-gray-500">Diagnóstico de Matemáticas - Subnivel Medio</p>
                    <p class="text-sm text-gray-400 mt-1" id="report-date"></p>
                </div>

                <!-- KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 text-center">
                        <p class="text-blue-800 text-xs font-bold uppercase tracking-wider">Total Evaluados</p>
                        <p class="text-4xl font-bold text-blue-900 mt-2" id="kpi-total">0</p>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 text-center">
                        <p class="text-indigo-800 text-xs font-bold uppercase tracking-wider">Promedio Nivel</p>
                        <p class="text-4xl font-bold text-indigo-900 mt-2" id="kpi-avg">0.0</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200 text-center">
                        <p class="text-green-800 text-xs font-bold uppercase tracking-wider">Éxito (N3/N4)</p>
                        <p class="text-4xl font-bold text-green-900 mt-2" id="kpi-success">0%</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg border border-red-200 text-center">
                        <p class="text-red-800 text-xs font-bold uppercase tracking-wider">En Riesgo (N1)</p>
                        <p class="text-4xl font-bold text-red-900 mt-2" id="kpi-risk">0</p>
                    </div>
                </div>

                <!-- Gráfico Principal -->
                <div class="mb-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 border-l-4 border-blue-500 pl-3">Promedio de Nivel por Pregunta</h3>
                    <div class="h-80 w-full bg-white border rounded p-2">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Tabla de Errores -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-800 mb-4 border-l-4 border-red-500 pl-3">Prevalencia de Errores</h3>
                        <div class="overflow-hidden rounded border border-gray-200">
                            <table class="min-w-full text-sm">
                                <thead class="bg-red-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left font-semibold text-red-800">Error Conceptual</th>
                                        <th class="px-4 py-2 text-center font-semibold text-red-800">Cant.</th>
                                        <th class="px-4 py-2 text-center font-semibold text-red-800">%</th>
                                    </tr>
                                </thead>
                                <tbody id="errors-table-body" class="bg-white"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Lista de Estudiantes -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-800 mb-4 border-l-4 border-gray-500 pl-3">Resultados Individuales</h3>
                        <div class="overflow-hidden rounded border border-gray-200">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-2 text-left font-semibold text-gray-700">Estudiante</th>
                                        <th class="px-4 py-2 text-center font-semibold text-gray-700">Prom.</th>
                                        <th class="px-4 py-2 text-center font-semibold text-gray-700">Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="students-table-body" class="divide-y divide-gray-100 bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="text-center text-xs text-gray-400 mt-8 pt-4 border-t">
                    Generado por EGMA Manager - USFQ School Fab Lab
                </div>
            </div>
        </div>
    </div>

    <!-- DATOS Y LÓGICA -->
    <script>
        // --- 1. DEFINICIÓN EXACTA DE LA RÚBRICA ---
        const rubricData = [
            {
                id: "1.1",
                title: "1.1 Concepto Histórico (Origen)",
                levels: [
                    { val: 1, label: "Nivel 1: Inicio", color: "text-red-600", text: "No da respuesta lógica o no entiende la necesidad de registro." },
                    { val: 2, label: "Nivel 2: Proceso", color: "text-orange-500", text: "Sugiere conteo simple pero sin método de registro físico." },
                    { val: 3, label: "Nivel 3: Adquirido", color: "text-green-600", text: "Propone marcas, piedras o símbolos (correspondencia 1 a 1)." },
                    { val: 4, label: "Nivel 4: Dominio", color: "text-blue-600", text: "Explica la lógica del sistema: necesidad de agrupar o inventar símbolos." }
                ]
            },
            {
                id: "1.2",
                title: "1.2 Lectura de Números (405.012.030)",
                levels: [
                    { val: 1, label: "Nivel 1: Inicio", color: "text-red-600", text: "Lee dígitos por separado (ej. 'cuatro, cero, cinco...')." },
                    { val: 2, label: "Nivel 2: Proceso", color: "text-orange-500", text: "Lee con dificultad, pausa en puntos de mil o ignora ceros intermedios." },
                    { val: 3, label: "Nivel 3: Adquirido", color: "text-green-600", text: "Lee fluidamente respetando periodos de millón y mil." },
                    { val: 4, label: "Nivel 4: Dominio", color: "text-blue-600", text: "Lectura automática, segura y correcta al primer intento." }
                ]
            },
            {
                id: "1.3",
                title: "1.3 Valor Posicional y Descomposición",
                levels: [
                    { val: 1, label: "Nivel 1: Inicio", color: "text-red-600", text: "No logra descomponer ni identificar valor posicional." },
                    { val: 2, label: "Nivel 2: Proceso", color: "text-orange-500", text: "Identifica valor (ej. 80 millones) pero falla la descomposición aditiva." },
                    { val: 3, label: "Nivel 3: Adquirido", color: "text-green-600", text: "Identifica valor y realiza la descomposición aditiva correctamente." },
                    { val: 4, label: "Nivel 4: Dominio", color: "text-blue-600", text: "Explica la lógica posicional y el rol del cero con fluidez." }
                ]
            },
            {
                id: "2.1",
                title: "2.1 Sucesiones Crecientes (Patrón complejo)",
                levels: [
                    { val: 1, label: "Nivel 1: Inicio", color: "text-red-600", text: "No identifica patrón o adivina números (solo maneja +1)." },
                    { val: 2, label: "Nivel 2: Proceso", color: "text-orange-500", text: "Identifica patrón (+50) pero comete errores de cálculo al sumar." },
                    { val: 3, label: "Nivel 3: Adquirido", color: "text-green-600", text: "Completa la sucesión correctamente (1.350)." },
                    { val: 4, label: "Nivel 4: Dominio", color: "text-blue-600", text: "Crea sucesiones complejas o explica la regla general verbalmente." }
                ]
            },
            {
                id: "2.2",
                title: "2.2 Sucesiones Decrecientes (Inversa)",
                levels: [
                    { val: 1, label: "Nivel 1: Inicio", color: "text-red-600", text: "No logra la cuenta regresiva o resta incorrectamente." },
                    { val: 2, label: "Nivel 2: Proceso", color: "text-orange-500", text: "Identifica que baja, pero erra en la resta (error de cálculo)." },
                    { val: 3, label: "Nivel 3: Adquirido", color: "text-green-600", text: "Completa correctamente (48) identificando patrón -8." },
                    { val: 4, label: "Nivel 4: Dominio", color: "text-blue-600", text: "Reconoce patrones inversos (relaciona con tabla del 8)." }
                ]
            },
            {
                id: "3.1",
                title: "3.1 Cálculo Mental (Fluidez)",
                levels: [
                    { val: 1, label: "Nivel 1: Inicio", color: "text-red-600", text: "Necesita conteo físico (dedos). Tasa error > 50%." },
                    { val: 2, label: "Nivel 2: Proceso", color: "text-orange-500", text: "Correcto pero lento (>5 seg/ítem). No automatizado." },
                    { val: 3, label: "Nivel 3: Adquirido", color: "text-green-600", text: "Recuperación automática (<3 seg/ítem) y correcta." },
                    { val: 4, label: "Nivel 4: Dominio", color: "text-blue-600", text: "Fluidez total. Aplica en contextos de estimación." }
                ]
            },
            {
                id: "3.2",
                title: "3.2 Estrategias y Trucos (x9, x1000)",
                levels: [
                    { val: 1, label: "Nivel 1: Inicio", color: "text-red-600", text: "No conoce trucos, intenta sumar repetidamente." },
                    { val: 2, label: "Nivel 2: Proceso", color: "text-orange-500", text: "Aplica truco mecánicamente pero se confunde al explicar." },
                    { val: 3, label: "Nivel 3: Adquirido", color: "text-green-600", text: "Usa trucos eficientemente (ej. agregar ceros)." },
                    { val: 4, label: "Nivel 4: Dominio", color: "text-blue-600", text: "Generaliza el truco a otros casos nuevos." }
                ]
            },
            {
                id: "4.1",
                title: "4.1 Resolución de Problemas",
                levels: [
                    { val: 1, label: "Nivel 1: Inicio", color: "text-red-600", text: "Error de modelado: No sabe qué operación usar." },
                    { val: 2, label: "Nivel 2: Proceso", color: "text-orange-500", text: "Identifica operación correcta pero falla en el algoritmo." },
                    { val: 3, label: "Nivel 3: Adquirido", color: "text-green-600", text: "Plantea y resuelve el problema correctamente." },
                    { val: 4, label: "Nivel 4: Dominio", color: "text-blue-600", text: "Propone múltiples estrategias o verifica sentido de respuesta." }
                ]
            },
            {
                id: "4.2",
                title: "4.2 Vocabulario Matemático",
                levels: [
                    { val: 1, label: "Nivel 1: Inicio", color: "text-red-600", text: "Desconoce términos ('cosa de arriba', 'respuesta')." },
                    { val: 2, label: "Nivel 2: Proceso", color: "text-orange-500", text: "Confunde multiplicando con multiplicador. No sabe 'Producto'." },
                    { val: 3, label: "Nivel 3: Adquirido", color: "text-green-600", text: "Identifica correctamente los 3 términos técnicos." },
                    { val: 4, label: "Nivel 4: Dominio", color: "text-blue-600", text: "Usa vocabulario técnico con naturalidad durante toda la prueba." }
                ]
            }
        ];

        const errorList = [
            { id: "err_sintaxis", text: "Sintaxis: Escribe '3000500' en vez de 3.500.000 (Concatenación)" },
            { id: "err_magnitud", text: "Magnitud: Falla al comparar números de igual longitud (405 vs 450)" },
            { id: "err_conteo", text: "Fluidez: Usa suma repetida en vez de multiplicar (7x6 = 7+7...)" },
            { id: "err_resta", text: "Resta: Resta invertida (siempre resta el número menor del mayor)" },
            { id: "err_modelo", text: "Modelado: Opera basándose solo en palabras clave sin contexto" },
            { id: "err_vocab", text: "Vocabulario: Confunde 'Producto' con 'Suma' o 'Diferencia'" }
        ];

        // --- 2. INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('evalDate').valueAsDate = new Date();
            document.getElementById('report-date').textContent = new Date().toLocaleDateString('es-EC', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            renderForm();
        });

        function switchTab(tab) {
            document.getElementById('view-evaluador').classList.toggle('hidden', tab !== 'evaluador');
            document.getElementById('view-analista').classList.toggle('hidden', tab !== 'analista');
            document.getElementById('btn-evaluador').classList.toggle('active', tab === 'evaluador');
            document.getElementById('btn-analista').classList.toggle('active', tab === 'analista');
        }

        // --- 3. RENDERIZADO DEL FORMULARIO (EVALUADOR) ---
        function renderForm() {
            const container = document.getElementById('questions-container');
            container.innerHTML = rubricData.map(q => `
                <div class="bg-white border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                    <div class="bg-blue-50 px-4 py-3 border-b flex justify-between items-center">
                        <h3 class="font-bold text-gray-800 text-lg">${q.title}</h3>
                        <span class="text-xs font-mono text-gray-500 bg-white border px-2 py-1 rounded">ID: ${q.id}</span>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            ${q.levels.map(lvl => `
                                <label class="block relative h-full group cursor-pointer">
                                    <input type="radio" name="q_${q.id}" value="${lvl.val}" class="radio-input sr-only">
                                    <div class="radio-content p-4 rounded-lg bg-white h-full flex flex-col hover:bg-blue-50">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-bold text-sm ${lvl.color} uppercase tracking-wider">${lvl.label}</span>
                                            <div class="w-5 h-5 rounded-full border border-gray-300 flex items-center justify-center bg-white group-hover:border-blue-400">
                                                <div class="w-3 h-3 rounded-full bg-blue-600 hidden check-indicator"></div>
                                            </div>
                                        </div>
                                        <p class="text-sm text-gray-600 flex-grow leading-relaxed">
                                            ${lvl.text}
                                        </p>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                        <div class="mt-4">
                            <input type="text" name="obs_${q.id}" class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2 border bg-gray-50" placeholder="Observaciones específicas para ${q.title}...">
                        </div>
                    </div>
                </div>
            `).join('');

            const errContainer = document.getElementById('errors-container');
            errContainer.innerHTML = errorList.map(err => `
                <div class="flex flex-col sm:flex-row sm:items-center justify-between border-b last:border-0 py-4 border-red-100 hover:bg-red-50 transition px-2 rounded">
                    <span class="text-gray-800 font-medium text-sm w-full sm:w-3/4 pr-4 mb-2 sm:mb-0 flex items-center">
                         <i class="fa-solid fa-circle-exclamation text-red-300 mr-2 text-xs"></i>
                         ${err.text}
                    </span>
                    <div class="flex space-x-6">
                        <label class="inline-flex items-center cursor-pointer group">
                            <input type="radio" name="${err.id}" value="si" class="text-red-600 focus:ring-red-500 h-5 w-5 border-gray-300">
                            <span class="ml-2 text-base font-bold text-gray-700 group-hover:text-red-700">Sí</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer group">
                            <input type="radio" name="${err.id}" value="no" class="text-green-600 focus:ring-green-500 h-5 w-5 border-gray-300" checked>
                            <span class="ml-2 text-base font-bold text-gray-700 group-hover:text-green-700">No</span>
                        </label>
                    </div>
                </div>
            `).join('');
        }

        function resetForm() {
            if(confirm('¿Seguro que deseas borrar todo el formulario?')) {
                document.getElementById('evalForm').reset();
                document.getElementById('evalDate').valueAsDate = new Date();
                window.scrollTo(0,0);
            }
        }

        // --- 4. GUARDAR DATOS (JSON) ---
        function saveData() {
            const student = document.getElementById('studentName').value;
            if (!student) { alert("Por favor ingrese el nombre del estudiante"); return; }

            const data = {
                meta: {
                    student: student,
                    grade: document.getElementById('studentGrade').value,
                    date: document.getElementById('evalDate').value,
                },
                scores: {},
                observations: {},
                errors: {}
            };

            rubricData.forEach(q => {
                const checked = document.querySelector(`input[name="q_${q.id}"]:checked`);
                data.scores[q.id] = checked ? parseInt(checked.value) : 0;
                const obs = document.querySelector(`input[name="obs_${q.id}"]`).value;
                if(obs) data.observations[q.id] = obs;
            });

            errorList.forEach(err => {
                const checked = document.querySelector(`input[name="${err.id}"]:checked`);
                data.errors[err.id] = checked ? checked.value : 'no';
            });

            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `EGMA_${student.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- 5. MODO ANALISTA Y PDF ---
        let chartInstance = null;

        async function processFiles(files) {
            if (files.length === 0) return;
            
            const results = [];
            const status = document.getElementById('upload-status');
            status.classList.remove('hidden');
            status.textContent = `Procesando ${files.length} archivos...`;

            for (let file of files) {
                try {
                    const text = await file.text();
                    results.push(JSON.parse(text));
                } catch (e) {
                    console.error("Error leyendo archivo", file.name, e);
                }
            }

            calculateAndRender(results);
            status.textContent = `¡Análisis Completado! ${results.length} evaluaciones cargadas.`;
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function calculateAndRender(data) {
            const totalStudents = data.length;
            let sumGlobal = 0;
            let countScores = 0;
            let studentsInRisk = 0; 
            let acquiredCount = 0; 

            const questionAvgs = {};
            rubricData.forEach(q => questionAvgs[q.id] = { sum: 0, count: 0 });

            const errorCounts = {};
            errorList.forEach(e => errorCounts[e.id] = 0);

            const studentDetails = [];

            data.forEach(d => {
                let sSum = 0;
                let sCount = 0;
                let n1Count = 0;

                Object.entries(d.scores).forEach(([qid, val]) => {
                    if (val > 0) {
                        sSum += val;
                        sCount++;
                        if (val === 1) n1Count++;
                        if (questionAvgs[qid]) {
                            questionAvgs[qid].sum += val;
                            questionAvgs[qid].count++;
                        }
                    }
                });

                Object.entries(d.errors).forEach(([eid, val]) => {
                    if (val === 'si' && errorCounts[eid] !== undefined) errorCounts[eid]++;
                });

                const sAvg = sCount > 0 ? (sSum / sCount) : 0;
                sumGlobal += sAvg;
                
                if (sAvg >= 3) acquiredCount++;
                const isRisk = n1Count >= 3;
                if (isRisk) studentsInRisk++;

                studentDetails.push({
                    name: d.meta.student,
                    avg: sAvg.toFixed(2),
                    status: isRisk ? 'Riesgo' : (sAvg >= 3 ? 'Adquirido' : 'En Proceso')
                });
            });

            document.getElementById('kpi-total').textContent = totalStudents;
            document.getElementById('kpi-avg').textContent = totalStudents > 0 ? (sumGlobal / totalStudents).toFixed(2) : "0.0";
            document.getElementById('kpi-success').textContent = totalStudents > 0 ? Math.round((acquiredCount / totalStudents) * 100) + "%" : "0%";
            document.getElementById('kpi-risk').textContent = studentsInRisk;

            const ctx = document.getElementById('mainChart').getContext('2d');
            const values = rubricData.map(q => {
                const qData = questionAvgs[q.id];
                return qData.count > 0 ? (qData.sum / qData.count).toFixed(2) : 0;
            });

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: rubricData.map(q => q.title.length > 25 ? q.title.substring(0, 25) + "..." : q.title),
                    datasets: [{
                        label: 'Promedio de Nivel (1-4)',
                        data: values,
                        backgroundColor: values.map(v => v < 2 ? '#ef4444' : v < 3 ? '#f59e0b' : '#10b981'),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { min: 0, max: 4 } }
                }
            });

            const tbodyErr = document.getElementById('errors-table-body');
            tbodyErr.innerHTML = errorList
                .map(err => {
                    const count = errorCounts[err.id];
                    const pct = totalStudents > 0 ? ((count / totalStudents) * 100).toFixed(1) : "0.0";
                    return { ...err, count, pct };
                })
                .sort((a, b) => b.count - a.count) 
                .map(err => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium text-gray-700">${err.text}</td>
                        <td class="px-4 py-3 text-center text-gray-900">${err.count}</td>
                        <td class="px-4 py-3 text-center text-red-600 font-bold">${err.pct}%</td>
                    </tr>
                `).join('');

            const tbodyStu = document.getElementById('students-table-body');
            tbodyStu.innerHTML = studentDetails.map(s => `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="px-4 py-3 font-medium text-gray-900">${s.name}</td>
                    <td class="px-4 py-3 text-center font-bold text-gray-700">${s.avg}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-3 py-1 rounded-full text-xs font-bold text-white ${s.status === 'Riesgo' ? 'bg-red-500' : s.status === 'Adquirido' ? 'bg-green-500' : 'bg-yellow-500'}">
                            ${s.status}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // --- FUNCIÓN PARA DESCARGAR PDF ---
        function downloadReportPDF() {
            const element = document.getElementById('report-content');
            const opt = {
                margin:       [10, 10, 10, 10], // top, left, bottom, right
                filename:     `Informe_EGMA_${new Date().toLocaleDateString().replace(/\//g, '-')}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            // Generar PDF
            html2pdf().set(opt).from(element).save();
        }
    </script>
</body>
</html>
